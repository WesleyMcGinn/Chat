<!DOCTYPE html>
<html>
  <head>
    <title id="tab_title">Chat</title>
    <link rel="icon" type="image/x-icon" href="./favicon.ico">
    <script src="https://kihtrak.com/cloud_variable/cloudify.min.js"></script>
    <style>
      body {
        background-image: linear-gradient(90deg, #1af, #5f7);
        background-color: #3db;
      }
      h1 {
        color: #ff0;
        font-size: 35px;
        font-family: 'Franklin Gothic Medium', sans-serif;
        background-color: #0005;
        padding: 7px;
        border-radius: 12px;
        margin-top: 0px;
      }
      h1:hover {
        cursor: default;
      }
      p {
        color: #000;
        font-size: 15px;
        font-family: Verdana, sans-serif;
      }
      label {
        color: #000;
        font-size: 15px;
        font-family: Verdana, sans-serif;
      }
      input {
        color: #00f;
        background-image: linear-gradient(#eef, #0ff);
        font-size: 15px;
        font-family: Tahoma, Verdana, sans-serif;
        padding: 7px;
        border-radius: 15px;
        border-style: solid;
        border-color: #017;
        border-width: 1px;
      }
      input:hover {
        border-style: dashed;
        cursor: text;
      }
      input:active {
        background-image: linear-gradient(#eef, #eff);
      }
      button {
        color: #000;
        background-image: linear-gradient(#0ff, #00f);
        font-size: 15px;
        font-family: Georgia, Times, serif;
        font-weight: 800;
        padding: 7px;
        border-radius: 15px;
        border-style: solid;
        border-color: #017;
        border-width: 1px;
      }
      button:hover {
        background-image: linear-gradient(#7ff, #57f);
        cursor: pointer;
      }
      button:active {
        border-width: 2px;
        cursor: grabbing;
      }
      textarea {
        color: #00f;
        background-color: #eef7;
        border-style: solid;
        border-width: 2px;
        border-color: #017;
        padding: 5px;
        font-family: Tahoma, Verdana, sans-serif;
        border-radius: 12px;
      }
      textarea:hover {
        border-style: dashed;
        cursor: text;
      }
      a:visited {
        color: #0a2;
      }
      a:link {
        color: #00f;
      }
      a:hover {
        font-size: 16px;
        cursor: pointer;
      }
      a:active {
        font-size: 15px;
        cursor: grabbing;
        background-color: #0ff;
      }
      table {
        border-style: none;
      }
      .center {
        text-align: center;
      }
      .right {
        text-align: right;
      }
      .left {
        text-align: left;
      }
    </style>
    <style id="CSS theme"></style>
  </head>
  <body onload="setup()" onunload="teardown()">
    <div class="center">
      <script type="text/javascript">

        var cloud_Chat_allChatRoomData;
        var name = '';
        var roomName = '';
        var roomPass = '';
        var roomNum = -1;
        var wait = null;
        var chatRefresh = null;
        var myColor = randomColor(false, false) + '80';
        var currentTheme = 0;

        var urlParameters = {
          link : location.href,
          get : function(variable_name) {
            if (this.link.search(variable_name + "=") >= 0) {
              this.preparedValue = '';
              for (i = this.link.search(variable_name + "=") + variable_name.length + 1; i < this.link.length; i++) {
                if (this.link[i] == '&' || this.link[i] == '/' || this.link[i] == '?') {
                  i = this.link.length;
                } else {
                  this.preparedValue += this.link[i];
                }
              }
              return this.preparedValue;
            } else {
              return null;
            }
          },
          has : function(variable_name) {
            if (this.link.search(variable_name + "=") >= 0) {
              return true;
            } else {
              return false;
            }
          }
        }
        
        function setup() {
          document.documentElement.style.cursor = "progress";
          wait = window.setInterval("setup$()", 1000); // Wait enough time for cloud data to load
        } function setup$() {
          window.clearInterval(wait);
          document.documentElement.style.cursor = 'auto';
          if (cloud_Chat_allChatRoomData == NaN || cloud_Chat_allChatRoomData == undefined || cloud_Chat_allChatRoomData == null) {
            cloud_Chat_allChatRoomData = [['TESTROOM', 'PASSWORD', 0, [], []], ['NO-PASS', '', 0, [], []]];
          }
          if (urlParameters.has('r')) {
            document.getElementById("Room_input").value = urlParameters.get('r').toUpperCase();
            if (urlParameters.has('p')) {
              enterRoom(urlParameters.get('r').toUpperCase(), urlParameters.get('p').toUpperCase());
            } else {
              enterRoom(urlParameters.get('r').toUpperCase(), '');
            }
          }
          if (urlParameters.has('p')) {
            document.getElementById("Pass_input").value = urlParameters.get('p').toUpperCase();
          }
          if (urlParameters.has('n')) {
            name = urlParameters.get('n');
            document.getElementById("Name2").style.display = 'none';
            document.getElementById("Name_input").value = name;
          } else {
            document.getElementById("Name2").style.display = '';
          }
          checkForPassword();
        }

        function teardown() {
          if (roomNum >= 0) {
            endChat();
          }
        }

        var theme = {
          options : ['blue-green'],
          data : ['body { background-image: linear-gradient(90deg, #1af, #5f7); background-color: #3db } h1 { color: #ff0; background-color: #0005 } p { color: #000 } label { color: #000 } input { color: #00f; background-image: linear-gradient(#eef, #0ff); border-color: #017 } input:active { background-image: linear-gradient(#eef, #eff) } button { color: #000; background-image: linear-gradient(#0ff, #00f); border-color: #017 } button:hover { background-image: linear-gradient(#7ff, #57f) } textarea { color: #00f } a:visited { color: #0a2 } a:link { color: #00f } a:active { background-color: #0ff }'],
          setByNumber : function(themeNumber) {
            document.getElementById("CSS theme").innerHTML = this.data[themeNumber];
            currentTheme = themeNumber;
          },
          setByName : function(themeName) {
            for (g = 0; g < this.options.length; g++) {
              if (this.options[g] == themeName) {
                document.getElementById("CSS theme").innerHTML = this.data[g];
                currentTheme = g;
              }
            }
          },
          next : function() {
            currentTheme += 1;
            if (currentTheme >= this.options.length) {
              currentTheme = 0;
            }
          },
          previous : function() {
            currentTheme -= 1;
            if (currentTheme < 0) {
              currentTheme = this.options.length - 1;
            }
          }
        }

        function proposeNewRoom() {
          if (name == '') {
            document.getElementById("Name_input").style.color = "red";
            document.getElementById("Name_input").style.borderColor = "red";
            document.getElementById("Name_input").value = "PLEASE ENTER NAME";
          } else {
            document.getElementById("Heading").innerHTML = "Create New Chat Room";
            document.getElementById("Welcome").style.display = 'none';
            document.getElementById("Create Chat Room").style.display = '';
          }
        }

        function refresh(element) {
          document.getElementById(element).style.color = "#00f";
          document.getElementById(element).style.borderColor = "#017";
          document.getElementById(element).value = '';
        }

        function home() {
          document.getElementById("Heading").innerHTML = "Chat";
          document.getElementById("Welcome").style.display = '';
          document.getElementById("Create Chat Room").style.display = 'none';
          if (document.getElementById("Chat").style.display == '') {
            endChat();
            document.getElementById("Chat").style.display = 'none';
          }
          
        }

        function checkForPassword() {
          var foundName = false;
          Room_Name = document.getElementById("Room_input").value.toUpperCase();
          for (i = 0; i < cloud_Chat_allChatRoomData.length; i++) {
            if (cloud_Chat_allChatRoomData[i][0] == Room_Name.toUpperCase()) {
              foundName = true;
              if (cloud_Chat_allChatRoomData[i][1] == '') {
                document.getElementById("getPass").style.display = 'none';
              } else {
                document.getElementById("getPass").style.display = '';
              }
            }
          }
          if (foundName == false) {
            document.getElementById("getPass").style.display = 'none';
          }
        }

        function newRoom() {
          document.getElementById("Heading").innerHTML = "Creating Room....";
          roomName = document.getElementById("New_room_input").value.toUpperCase();
          roomPass = document.getElementById("New_pass_input").value.toUpperCase();
          var ID_good = true;
          for (i = 0; i < cloud_Chat_allChatRoomData.length; i++) {
            if (cloud_Chat_allChatRoomData[i][0] == roomName) {
              ID_good = false;
            }
          }
          if (ID_good == true) {
            roomNum =  cloud_Chat_allChatRoomData.push([roomName, roomPass, 0, [], []]);
            wait = window.setInterval("enterRoom('" + roomName + "', '" + roomPass + "')", 200);
          } else {
            document.getElementById("Heading").innerHTML = "Create New Chat Room";
            document.getElementById("New_room_input").value = "ID Taken :(";
            document.getElementById("New_room_input").style.color = "red";
            document.getElementById("New_room_input").style.borderColor = "red";
          }
        }

        function enterRoom(Room_Name, Room_Pass) {
          window.clearInterval(wait);
          if (Room_Name == '') {
            Room_Name = document.getElementById("Room_input").value.toUpperCase();
            Room_Pass = document.getElementById("Pass_input").value.toUpperCase();
          } else {
            document.getElementById("Room_input").value = Room_Name.toUpperCase();
            document.getElementById("Pass_input").value = Room_Pass.toUpperCase();
          }
          var foundName = false;
          for (i = 0; i < cloud_Chat_allChatRoomData.length; i++) {
            if (cloud_Chat_allChatRoomData[i][0] == Room_Name.toUpperCase()) {
              foundName = true;
              if (cloud_Chat_allChatRoomData[i][1] == Room_Pass.toUpperCase() || cloud_Chat_allChatRoomData[i][1] == '') {
                roomNum = i;
                roomName = Room_Name.toUpperCase();
                roomPass = null;
                cloud_Chat_allChatRoomData[i][2] += 1;
                document.getElementById("Heading").innerHTML = "Chat Room: " + roomName.toUpperCase();
                document.getElementById("Welcome").style.display = 'none';
                document.getElementById("Create Chat Room").style.display = 'none';
                document.getElementById("Chat").style.display = '';
                if (cloud_Chat_allChatRoomData[roomNum][4].length > 0) {
                  var deletionMessage = '';
                  for (j = 0; j < cloud_Chat_allChatRoomData[roomNum][4].length; j++) {
                    deletionMessage += cloud_Chat_allChatRoomData[roomNum][4][j];
                    if (j == cloud_Chat_allChatRoomData[roomNum][4].length - 2) {
                      deletionMessage += ", and ";
                    } else {
                      if (j < cloud_Chat_allChatRoomData[roomNum][4].length - 2) {
                        deletionMessage += ", ";
                      }
                    }
                  }
                  if (cloud_Chat_allChatRoomData[roomNum][4].length == 1) {
                    deletionMessage += ' has ';
                  } else {
                    deletionMessage += ' have ';
                  }
                  deletionMessage += 'requested to clear this chat room.  <button onclick="clear_chat.vote.yes()">Agree</button> <button onclick="clear_chat.vote.no()">Disagree</button>';
                  document.getElementById("ClearRequests").innerHTML = deletionMessage;
                  document.getElementById("ClearRequests").style.display = '';
                }
                printMessages();
              } else {
                document.getElementById("Pass_input").style.color = "red";
                document.getElementById("Pass_input").style.borderColor = "red";
              }
            }
          }
          if (foundName == false) {
            document.getElementById("Room_input").value = "ID n/a :(";
            document.getElementById("Room_input").style.color = "red";
            document.getElementById("Room_input").style.borderColor = "red";
          }
        }

        function randomHexidecimals(times) {
          var output = '';
          for (h = 0; h < times; h++) {
	          output += (Math.floor(Math.random()*16).toString(16));
          }
          return output;
        }
        function randomColor(emmet, transparency) {
          if (emmet == true && transparency == false) { return "#" + randomHexidecimals(3); }
          if (emmet == true && transparency == true) { return "#" + randomHexidecimals(4); }
          if (emmet == false && transparency == false) { return "#" + randomHexidecimals(6); }
          if (emmet == false && transparency == true) { return "#" + randomHexidecimals(8); }
        }

        function newColor() {
          var previousColor = myColor;
          myColor = randomColor(false, false) + "80";
          document.getElementById("Preview").style.backgroundColor = myColor;
          for (i = 0; i < cloud_Chat_allChatRoomData[roomNum][3].length; i++) {
            if (cloud_Chat_allChatRoomData[roomNum][3][i].replace(previousColor, myColor) != cloud_Chat_allChatRoomData[roomNum][3][i]) {
              cloud_Chat_allChatRoomData[roomNum][3][i] = cloud_Chat_allChatRoomData[roomNum][3][i].replace(previousColor, myColor);
            }
          }
        }

        var clear_chat = {
          vote : {
            yes : function() {
              cloud_Chat_allChatRoomData[roomNum][4].unshift(name);
              document.getElementById("ClearRequests").style.display = 'none';
              document.getElementById("ClearRequests").innerHTML = '';
            },
            no : function() {
              cloud_Chat_allChatRoomData[roomNum][4] = [];
              document.getElementById("ClearRequests").style.display = 'none';
              document.getElementById("ClearRequests").innerHTML = '';
            }
          },
          check : function() {
            if (cloud_Chat_allChatRoomData[roomNum][4].length >= cloud_Chat_allChatRoomData[roomNum][2] && cloud_Chat_allChatRoomData[roomNum][2] > 1) {
              cloud_Chat_allChatRoomData[roomNum][4] = [];
              cloud_Chat_allChatRoomData[roomNum][3] = [];
            }
            if (cloud_Chat_allChatRoomData[roomNum][4].length == 0) {
              if (document.getElementById("ClearRequests").innerHTML != '') {
                document.getElementById("ClearRequests").style.display = 'none';
                document.getElementById("ClearRequests").innerHTML = '';
              }
            }
          }
        }

        function updateName(element) {
          name = document.getElementById(element).value;
          document.getElementById("Name_input").value = name;
          document.getElementById("Name_input_2").value = name;
        }

        function post() {
          if (name != '') {
            cloud_Chat_allChatRoomData[roomNum][3].unshift("<p style='padding: 7px; background-color: " + myColor + "; border-radius: 12px'>" + document.getElementById("Write").value + "<br>-" + name + "</p>");
            document.getElementById("Write").value = 'Type a message here....';
            document.getElementById("Preview").innerHTML = '';
          } else {
            document.getElementById("Name_input_2").style.color = "red";
            document.getElementById("Name_input_2").style.borderColor = "red";
            document.getElementById("Name_input_2").value = "PLEASE ENTER NAME";
          }
        }

        function startChat() {
          if (name != '') {
            chatRefresh = window.setInterval("refreshChat()", 100);
            document.getElementById("Preview").style.backgroundColor = myColor;
            if (document.getElementById("Write").value == 'Type a message here....') {
              document.getElementById("Write").value = '';
            }
          } else {
            document.getElementById("Name_input_2").style.color = "red";
            document.getElementById("Name_input_2").style.borderColor = "red";
            document.getElementById("Name_input_2").value = "PLEASE ENTER NAME";
          }
        }

        function endChat() {
          if (chatRefresh != null) {
            window.clearInterval(chatRefresh);
          }
          cloud_Chat_allChatRoomData[roomNum][2] -= 1;
          document.getElementById("Write").value = '';
          document.getElementById("Preview").innerHTML = '';
        }

        function refreshChat() {
          clear_chat.check();
          if (document.getElementById("Write").value != 'Type a message here....') {
            if (document.getElementById("Preview").innerHTML != document.getElementById("Write").value + "<br>-" + name) {
              document.getElementById("Preview").innerHTML = document.getElementById("Write").value + "<br>-" + name;
            }
          }
          printMessages();
        }

      </script>
      <noscript><p style="color: red"><b><u>ERROR:</u></b> Your web browser does not suppport javascript or you have it disabled in your settings.  Javascript is required to run nearly anything on the internet besides loading basic documents.  As should be expected, JavaScript must be enabled on your computer in order for you to use this.</p></noscript>
      <h1 id="Heading">Chat</h1>
      <div id="Welcome">
        <p>Welcome to "Chat", a simple, fast-loading, and easy-to-use messaging app developed by <a href="https://github.com/WesleyMcGinn">Wesley McGinn</a>.</p><br>
        <p>
          <label for="Name_input">Your Name:  </label>
          <input id="Name_input" type="text" size="41" onclick="refresh('Name_input')" oninput="document.getElementById('Name2').style.display = 'none'; updateName('Name_input')" autofocus>
        </p>
        <br>
        <p>
          <label for="Room_input">Chat Room ID: </label>
          <input id="Room_input" type="text" size="7" oninput="checkForPassword()" onclick="refresh('Room_input')"> 
          OR 
          <button onclick="proposeNewRoom()">Create New Chat Room</button>
        </p>
        <p id="getPass" style="display: none">
          <label for="Pass_input">Chat Room Password: </label>
          <input id="Pass_input" type="password" size="30" onclick="refresh('Pass_input')">
        </p>
        <br>
        <button onclick="enterRoom('', '')">GO →</button>
      </div>
      <div id="Create Chat Room" style="display: none">
        <p>
          <label for="New_room_input">ID for New Room: </label>
          <input id="New_room_input" type="text" size="7" onclick="refresh('New_room_input')">
        </p>
        <p>
          <label for="New_pass_input">Room Password*:  </label>
          <input id="New_pass_input" type="text" size="7">
        </p>
        <p>
          *Leave the password space blank to disable the need to type in a password to get in.  It will then be possible, yet unlikely, for a random person to access your Chat Room.
        </p>
        <br>
        <button onclick="home()">Back</button> 
        <button onclick="newRoom()">Create Room →</button>
      </div>
      <div id="Chat" style="display: none">
        <p id="Name2">
          <label for="Name_input_2">Your Name:  </label>
          <input id="Name_input_2" type="text" size="41" onclick="refresh('Name_input_2')" oninput="updateName('Name_input_2')">  
          <button onclick="document.getElementById('Name2').style.display = 'none'">Enter</button>
          <br>
        </p>
        <p id="ClearRequests" style="color: red"></p>
        <p>
          <button onclick="home()">Home</button>
          <button onclick="theme(1)">New Theme</button>
          <button onclick="newColor()">New Color</button>
          <button onclick="clear_chat.vote.yes()">Clear All</button>
          <button onclick="">Extension</button>
        </p>
        <br>
        <textarea id="Write" cols="57" rows="5" onclick="startChat()">Type a message here....</textarea>
        <p id="Preview" style="padding: 7px; background-color: #eef5; border-radius: 12px"></p>
        <button onclick="post()">Post</button>
        <br>
        <div id="Messages"></div>
      </div>
    </div>
  </body>
</html>