<!DOCTYPE html>
<html>
  <head>
    <title id="tab_title">Chat</title>
    <link rel="icon" type="image/x-icon" href="http://192.168.1.100/favicon.ico">
    <link rel="stylesheet" href="./style.css">
  </head>
  <body onload="setup()" onunload="teardown()">
    <div class="center">
      <script id="Data reader" type="text/javascript"></script>
      <script type="text/javascript">

        var socketData;
        var recent_socketData;
        var name = '';
        var roomName = '';
        var roomPass = '';
        var roomNum = -1;
        var wait = null;
        var chatRefresh = null;
        var myColor = randomColor(false, false) + '80';
        var chatRunning = false;
        var messageContent = '';
        var oldMessageContent = '';
        var baseLink;

        let socket = new WebSocket("ws://192.168.1.100:8081");

        socket.onmessage = function(event) {
          document.getElementById("Data reader").innerHTML = "function setData() { recent_socketData = " + event.data + "; socketData = recent_socketData; }";
          setData();
        }

        function sendData() {
          if (socketData != recent_socketData && socket.readyState == 1) {
            socket.send(JSON.stringify(socketData));
            recent_socketData = socketData;
          }
        }

        var urlParameters = {
          link : location.href,
          get : function(variable_name) {
            if (this.link.search(variable_name + "=") >= 0) {
              this.preparedValue = '';
              for (i = this.link.search(variable_name + "=") + variable_name.length + 1; i < this.link.length; i++) {
                if (this.link[i] == '&' || this.link[i] == '/' || this.link[i] == '?') {
                  i = this.link.length;
                } else {
                  this.preparedValue += this.link[i];
                }
              }
              return this.preparedValue;
            } else {
              return null;
            }
          },
          has : function(variable_name) {
            if (this.link.search(variable_name + "=") >= 0) {
              return true;
            } else {
              return false;
            }
          }
        }
        
        function setup() {
          if (socketData == NaN || socketData == undefined || socketData == null) {
            socketData = [['TESTROOM', 'PASSWORD', 0, [], []], ['NO-PASS', '', 0, [], []]];
          }
          if (urlParameters.has('r')) {
            document.getElementById("Room_input").value = urlParameters.get('r').toUpperCase();
            if (urlParameters.has('p')) {
              enterRoom(urlParameters.get('r').toUpperCase(), urlParameters.get('p').toUpperCase());
            } else {
              enterRoom(urlParameters.get('r').toUpperCase(), '');
            }
          }
          if (urlParameters.has('p')) {
            document.getElementById("Pass_input").value = urlParameters.get('p').toUpperCase();
          }
          if (urlParameters.has('n')) {
            name = urlParameters.get('n');
            document.getElementById("Name2").style.display = 'none';
            document.getElementById("Name_input").value = name;
          } else {
            document.getElementById("Name2").style.display = '';
          }
          checkForPassword();
          window.setInterval("sendData()", 100);
          if (location.href.indexOf('?') < 0) {
            baseLink = location.href;
          } else {
            baseLink = location.href.substr(0,location.href.indexOf('?'));
          }
        }

        function teardown() {
          if (roomNum >= 0) {
            endChat();
          }
        }

        function proposeNewRoom() {
          if (name == '') {
            document.getElementById("Name_input").style.color = "red";
            document.getElementById("Name_input").style.borderColor = "red";
            document.getElementById("Name_input").value = "PLEASE ENTER NAME";
          } else {
            document.getElementById("Heading").innerHTML = "Create New Chat Room";
            document.getElementById("Welcome").style.display = 'none';
            document.getElementById("Create Chat Room").style.display = '';
          }
        }

        function refresh(element) {
          document.getElementById(element).style.color = "#00f";
          document.getElementById(element).style.borderColor = "#017";
          document.getElementById(element).value = '';
        }

        function home() {
          document.getElementById("Heading").innerHTML = "Chat";
          document.getElementById("Welcome").style.display = '';
          document.getElementById("Create Chat Room").style.display = 'none';
          if (document.getElementById("Chat").style.display == '') {
            endChat();
            document.getElementById("Chat").style.display = 'none';
          }
        }

        function checkForPassword() {
          var foundName = false;
          Room_Name = document.getElementById("Room_input").value.toUpperCase();
          for (i = 0; i < socketData.length; i++) {
            if (socketData[i][0] == Room_Name.toUpperCase()) {
              foundName = true;
              if (socketData[i][1] == '') {
                document.getElementById("getPass").style.display = 'none';
              } else {
                document.getElementById("getPass").style.display = '';
              }
            }
          }
          if (foundName == false) {
            document.getElementById("getPass").style.display = 'none';
          }
        }

        function newRoom() {
          document.getElementById("Heading").innerHTML = "Creating Room....";
          roomName = document.getElementById("New_room_input").value.toUpperCase();
          roomPass = document.getElementById("New_pass_input").value.toUpperCase();
          var ID_good = true;
          for (i = 0; i < socketData.length; i++) {
            if (socketData[i][0] == roomName) {
              ID_good = false;
            }
          }
          if (ID_good == true) {
            roomNum =  socketData.push([roomName, roomPass, 0, [], []]);
            wait = window.setInterval("enterRoom('" + roomName + "', '" + roomPass + "')", 200);
          } else {
            document.getElementById("Heading").innerHTML = "Create New Chat Room";
            document.getElementById("New_room_input").value = "ID Taken :(";
            document.getElementById("New_room_input").style.color = "red";
            document.getElementById("New_room_input").style.borderColor = "red";
          }
        }

        function enterRoom(Room_Name, Room_Pass) {
          window.clearInterval(wait);
          if (Room_Name == '') {
            Room_Name = document.getElementById("Room_input").value.toUpperCase();
            Room_Pass = document.getElementById("Pass_input").value.toUpperCase();
          } else {
            document.getElementById("Room_input").value = Room_Name.toUpperCase();
            document.getElementById("Pass_input").value = Room_Pass.toUpperCase();
          }
          var foundName = false;
          for (i = 0; i < socketData.length; i++) {
            if (socketData[i][0] == Room_Name.toUpperCase()) {
              foundName = true;
              if (socketData[i][1] == Room_Pass.toUpperCase() || socketData[i][1] == '') {
                roomNum = i;
                roomName = Room_Name.toUpperCase();
                roomPass = null;
                socketData[i][2] += 1;
                document.getElementById("Heading").innerHTML = "Chat Room: " + roomName.toUpperCase();
                document.getElementById("Welcome").style.display = 'none';
                document.getElementById("Create Chat Room").style.display = 'none';
                document.getElementById("Chat").style.display = '';
                clear_chat.check();
                printMessages();
                if (socketData[roomNum][4].indexOf(name) == -1) {
                  document.getElementById("clear button").style.display = '';
                }
              } else {
                document.getElementById("Pass_input").style.color = "red";
                document.getElementById("Pass_input").style.borderColor = "red";
              }
            }
          }
          if (foundName == false) {
            document.getElementById("Room_input").value = "ID n/a :(";
            document.getElementById("Room_input").style.color = "red";
            document.getElementById("Room_input").style.borderColor = "red";
          }
        }

        function randomHexidecimals(times) {
          var output = '';
          for (h = 0; h < times; h++) {
	          output += (Math.floor(Math.random()*16).toString(16));
          }
          return output;
        }
        function randomColor(emmet, transparency) {
          if (emmet == true && transparency == false) { return "#" + randomHexidecimals(3); }
          if (emmet == true && transparency == true) { return "#" + randomHexidecimals(4); }
          if (emmet == false && transparency == false) { return "#" + randomHexidecimals(6); }
          if (emmet == false && transparency == true) { return "#" + randomHexidecimals(8); }
        }

        function newColor() {
          var previousColor = myColor;
          myColor = randomColor(false, false) + "80";
          document.getElementById("Preview").style.backgroundColor = myColor;
          for (i = 0; i < socketData[roomNum][3].length; i++) {
            if (socketData[roomNum][3][i].replace(previousColor, myColor) != socketData[roomNum][3][i]) {
              socketData[roomNum][3][i] = socketData[roomNum][3][i].replace(previousColor, myColor);
            }
          }
          printMessages();
        }

        var clear_chat = {
          vote : {
            yes : function(fromButton = false) {
              socketData[roomNum][4].unshift(name);
              document.getElementById("ClearRequests").style.display = 'none';
              document.getElementById("ClearRequests").innerHTML = '';
              document.getElementById("clear button").style.display = 'none';
              if (fromButton == true) {
                document.getElementById("ClearRequests").style.display = '';
                document.getElementById("ClearRequests").innerHTML = 'You have sucessfully voted to clear this chat.';
                this.waitToClose = window.setInterval("clear_chat.closeDialog()", 3500);
              }
            },
            no : function() {
              socketData[roomNum][4] = [];
              document.getElementById("ClearRequests").style.display = 'none';
              document.getElementById("ClearRequests").innerHTML = '';
            }
          },
          closeDialog : function() {
            if (document.getElementById("ClearRequests").innerHTML == 'You have sucessfully voted to clear this chat.') {
              document.getElementById("ClearRequests").style.display = 'none';
              document.getElementById("ClearRequests").innerHTML = '';
            }
            window.clearInterval(this.waitToClose);
          },
          check : function() {
            if (socketData[roomNum][4].length >= socketData[roomNum][2] && socketData[roomNum][2] > 1) {
              socketData[roomNum][4] = [];
              socketData[roomNum][3] = [];
              document.getElementById("clear button").style.display = '';
              printMessages();
            }
            if (socketData[roomNum][4].length == 0) {
              if (document.getElementById("ClearRequests").innerHTML != '') {
                document.getElementById("ClearRequests").style.display = 'none';
                document.getElementById("ClearRequests").innerHTML = '';
              }
            }
            if (socketData[roomNum][4].length > 0) {
              var deletionMessage = '';
              for (j = 0; j < socketData[roomNum][4].length; j++) {
                deletionMessage += socketData[roomNum][4][j];
                if (j == socketData[roomNum][4].length - 2) {
                  if (socketData[roomNum][4].length == 2) {
                    deletionMessage += " and ";
                  } else {
                    deletionMessage += ", and ";
                  }
                } else {
                  if (j < socketData[roomNum][4].length - 2) {
                    deletionMessage += ", ";
                  }
                }
              }
              if (socketData[roomNum][4].length == 1) {
                deletionMessage += ' has ';
              } else {
                deletionMessage += ' have ';
              }
              deletionMessage += 'requested to clear this chat room.  ';
              if (socketData[roomNum][4].indexOf(name) == -1) {
                deletionMessage += '<button onclick="clear_chat.vote.yes()">Agree</button> <button onclick="clear_chat.vote.no()">Disagree</button>';
              } else {
                deletionMessage += '<button onclick="clear_chat.vote.no()">Undo</button>';
              }
              if (document.getElementById("ClearRequests").innerHTML != deletionMessage) {
                document.getElementById("ClearRequests").innerHTML = deletionMessage;
              }
              document.getElementById("ClearRequests").style.display = '';
            }
          },
          waitToClose : null,
        }

        function updateName(element) {
          name = document.getElementById(element).value;
          document.getElementById("Name_input").value = name;
          document.getElementById("Name_input_2").value = name;
        }

        function post() {
          if (name != '') {
            socketData[roomNum][3].unshift("<div style='padding: 7px; background-color: " + myColor + "; border-radius: 12px'>" + document.getElementById("Write").value + "<br>-" + name + "</div>");
            document.getElementById("Write").value = 'Type a message here....';
            document.getElementById("Preview").innerHTML = '';
          } else {
            document.getElementById("Name_input_2").style.color = "red";
            document.getElementById("Name_input_2").style.borderColor = "red";
            document.getElementById("Name_input_2").value = "PLEASE ENTER NAME";
          }
        }

        function startChat() {
          if (chatRunning == false) {
            if (name != '') {
              chatRunning = true;
              chatRefresh = window.setInterval("refreshChat()", 100);
              document.getElementById("Preview").style.backgroundColor = myColor;
            } else {
              document.getElementById("Name_input_2").style.color = "red";
              document.getElementById("Name_input_2").style.borderColor = "red";
              document.getElementById("Name_input_2").value = "PLEASE ENTER NAME";
            }
          }
          if (document.getElementById("Write").value == 'Type a message here....' && name != '') {
            document.getElementById("Write").value = '';
          }
        }

        function endChat() {
          if (chatRunning == true) {
            chatRunning = false;
            if (chatRefresh != null) {
              window.clearInterval(chatRefresh);
            }
            socketData[roomNum][2] -= 1;
            document.getElementById("Write").value = '';
            document.getElementById("Preview").innerHTML = '';
          }
        }

        function refreshChat() {
          if (chatRunning == true) {
            clear_chat.check();
            if (document.getElementById("Write").value != 'Type a message here....') {
              if (document.getElementById("Preview").innerHTML != document.getElementById("Write").value + "<br>-" + name) {
                document.getElementById("Preview").innerHTML = document.getElementById("Write").value + "<br>-" + name;
              }
            }
            printMessages();
          } else {
            window.clearInterval(chatRefresh);
          }
        }

        function printMessages() {
          messageContent = socketData[roomNum][3].join("<!--Next--><br>");
          if (messageContent != oldMessageContent) {
            document.getElementById("Messages").innerHTML = messageContent;
            oldMessageContent = messageContent;
          }
        }

        var link = {
          start : function() {
            if (document.getElementById("Link Output").style.display != '') {
              document.getElementById("Link Output").style.display = '';
              this.refresh();
            } else {
              document.getElementById("Link Output").style.display = 'none';
            }
          },
          refresh : function() {
            document.getElementById("link").innerHTML = baseLink + "?r=" + roomName;
            if (socketData[roomNum][1] != '') {
              document.getElementById("link").innerHTML += "&p=" + socketData[roomNum][1];
            }
            if (document.getElementById("linkForm name").checked == true) {
              document.getElementById("linkForm text").style.display = '';
              if (document.getElementById("linkForm text").value != '') {
                document.getElementById("link").innerHTML += "&n=" + document.getElementById("linkForm text").value;
              }
            } else {
              document.getElementById("linkForm text").style.display = 'none';
            }
          },
          copy : function() {
            this.copyLink = baseLink + "?r=" + roomName;
            if (socketData[roomNum][1] != '') {
              this.copyLink += "&p=" + socketData[roomNum][1];
            }
            if (document.getElementById("linkForm name").checked == true) {
              if (document.getElementById("linkForm text").value != '') {
                this.copyLink += "&n=" + document.getElementById("linkForm text").value;
              }
            }
            navigator.clipboard.writeText(this.copyLink);
            document.getElementById("Link Output").style.display = 'none';
          }
        }

      </script>
      <noscript><p class="warning"><b><u>ERROR:</u></b> Your web browser does not suppport javascript or you have it disabled in your settings.  Javascript is required to run nearly anything on the internet besides loading basic documents.  As should be expected, JavaScript must be enabled on your computer in order for you to use this.</p></noscript>
      <h1 id="Heading">Chat</h1>
      <div id="Welcome">
        <p>
          Welcome to "Chat", a simple, fast-loading, and easy-to-use messaging site hosted on the local network.  <br><br>
          <a href="http://192.168.1.100/LICENSE" target="_blank">License</a>    
          <a href="https://github.com/WesleyMcGinn/Chat" target="_blank">Code</a>
        </p><br>
        <p>
          <label for="Name_input">Your Name:  </label>
          <input id="Name_input" type="text" size="41" onclick="refresh('Name_input')" oninput="document.getElementById('Name2').style.display = 'none'; updateName('Name_input')" autofocus>
        </p><br>
        <p>
          <label for="Room_input">Chat Room ID: </label>
          <input id="Room_input" type="text" size="7" oninput="checkForPassword()" onclick="refresh('Room_input')"> 
          OR 
          <button onclick="proposeNewRoom()">Create New Chat Room</button>
        </p>
        <p id="getPass" style="display: none">
          <label for="Pass_input">Chat Room Password: </label>
          <input id="Pass_input" type="password" size="30" onclick="refresh('Pass_input')">
        </p><br>
        <button onclick="enterRoom('', '')">GO →</button>
      </div>
      <div id="Create Chat Room" style="display: none">
        <p>
          <label for="New_room_input">ID for New Room: </label>
          <input id="New_room_input" type="text" size="7" onclick="refresh('New_room_input')">
        </p>
        <p>
          <label for="New_pass_input">Room Password*:  </label>
          <input id="New_pass_input" type="text" size="7">
        </p>
        <p>
          *Leave the password space blank to disable the need to type in a password to get in.  It will then be possible, yet unlikely, for a random person to access your Chat Room.
        </p><br>
        <button onclick="home()">Back</button> 
        <button onclick="newRoom()">Create Room →</button>
      </div>
      <div id="Chat" style="display: none">
        <p id="Name2">
          <label for="Name_input_2">Your Name:  </label>
          <input id="Name_input_2" type="text" size="41" onclick="refresh('Name_input_2')" oninput="updateName('Name_input_2')">  
          <button onclick="document.getElementById('Name2').style.display = 'none'">Enter</button><br>
        </p>
        <p id="ClearRequests" class="warning"></p>
        <div id="Link Output" style="display: none">
          <p>The generated link will lead to this website and automatically enter the room ID and password. You can also make the link automatically enter someone's name automatically.</p><br>
          <input id="linkForm name" type="checkbox" class="checkbox" onclick="link.refresh()"><label for="linkForm name">Enter name automatically</label><br>
          <label for="linkForm text" style="display: none">Who is this link for? </label><input id="linkForm text" type="text" size="30" style="display: none" oninput="link.refresh()"><br>
          <p id="link" class="copy_content" onclick="link.copy()"></p>
          <p>Click the link above to copy it.</p><br>
        </div>
        <p>
          <button onclick="home()">Home</button>
          <button onclick="clear_chat.vote.yes(true); this.style.display = 'none'" id="clear button">Clear All</button>
          <button onclick="newColor()">New Color</button>
          <button onclick="link.start()">Link</button>
          <button onclick="window.open('https://github.com/WesleyMcGinn/Chat/tree/main/Chrome%20Extension', '_blank')">Extension</button>
        </p><br>
        <textarea id="Write" cols="57" rows="5" onclick="startChat()" onfocus="startChat()">Type a message here....</textarea>
        <div id="Preview" style="padding: 7px; background-color: #eef5; border-radius: 12px"></div><br>
        <button onclick="post()">Post</button><br><br>
        <div id="Messages"></div>
      </div>
    </div>
  </body>
</html>